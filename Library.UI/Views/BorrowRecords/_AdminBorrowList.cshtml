@model IEnumerable<Library.UI.Models.BorrowRecordListViewModel>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="row mb-3">
    <div class="col-md-6">
        <input type="text" id="searchInput" onkeyup="searchTable()" class="form-control" placeholder="🔍 Kitap veya kullanıcı ara...">
    </div>
</div>

@if (!Model.Any())
{
    <div class="alert alert-info mt-3">Sistemde ödünç kaydı bulunmamaktadır.</div>
}
else
{
    <table class="table table-striped table-hover mt-3 align-middle" id="borrowTable">
        <thead class="table-dark">
            <tr>
                <th>Kitap Adı</th>
                <th>Ödünç Alan</th>
                <th>Ödünç Tarihi</th>
                <th>Durum / Talep</th>
                <th class="text-end pe-3">İşlemler</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.OrderByDescending(x => x.BorrowDate))
            {
                <tr>
                    <td class="fw-bold">@item.BookTitle</td>
                    <td>@item.UserName</td>
                    <td>@item.BorrowDate.ToShortDateString()</td>

                    <td>
                        @if (item.IsReturned)
                        {
                            <span class="badge bg-success">Teslim Alındı</span>
                        }
                        else
                        {
                            @if (item.ReturnRequestStatus == 1) @* 1 = Pending *@
                            {
                                <span class="badge bg-warning text-dark animate__animated animate__pulse animate__infinite">
                                    <i class="fa-solid fa-hourglass-half"></i> Onay Bekliyor
                                </span>
                            }
                            else if (item.ReturnRequestStatus == 3) @* 3 = Rejected *@
                            {
                                <span class="badge bg-danger">Talep Reddedildi</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">Kullanıcıda</span>
                            }
                        }
                    </td>

                    <td class="text-end pe-3">
                        @* Sadece iade talebi varsa Onayla/Reddet butonlarını göster *@
                        @if (!item.IsReturned && item.ReturnRequestStatus == 1)
                        {
                            <div class="d-inline-flex gap-1">
                                <form asp-controller="BorrowRecords" asp-action="ApproveReturn" asp-route-id="@item.Id" method="post" id="approve-form-@item.Id" style="display:inline;">
                                    <button type="button" class="btn btn-sm btn-outline-success" onclick="confirmBorrowAction('@item.Id', 'approve')">
                                        <i class="fa-solid fa-check"></i> Onayla
                                    </button>
                                </form>

                                <form asp-controller="BorrowRecords" asp-action="RejectReturn" asp-route-id="@item.Id" method="post" id="reject-form-@item.Id" style="display:inline;">
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="confirmBorrowAction('@item.Id', 'reject')">
                                        <i class="fa-solid fa-xmark"></i> Reddet
                                    </button>
                                </form>
                            </div>
                        }

                        <form id="deleteForm_@item.Id" asp-controller="BorrowRecords" asp-action="Delete" asp-route-id="@item.Id" method="post" style="display:inline;" class="ms-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="confirmDelete('@item.Id')">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </form>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

<script>
        // Onayla ve Reddet Butonları İçin SweetAlert (Ters Mantık Düzenlemesi)
        function confirmBorrowAction(id, type) {
            const isApprove = type === 'approve';
        Swal.fire({
            title: isApprove ? 'İadeyi Onayla' : 'İadeyi Reddet',
        text: isApprove ? "Kitabı teslim aldığınızı onaylıyor musunuz?" : "İade talebini reddetmek istediğinize emin misiniz?",
        icon: isApprove ? 'success' : 'warning',
        showCancelButton: true,
        confirmButtonColor: '#6c757d', // Gri Renk (Vazgeç butonu için)
        cancelButtonColor: isApprove ? '#198754' : '#dc3545', // Yeşil veya Kırmızı (Evet butonu için)
        confirmButtonText: 'Vazgeç',   // Sol taraftaki ana buton "Vazgeç" oldu
        cancelButtonText: 'Evet',      // Sağ taraftaki işlem butonu "Evet" oldu
        reverseButtons: true           // Butonların yerini (Evet sağda, Vazgeç solda) sabitler
            }).then((result) => {
                // "Evet" butonuna basıldığında (yani cancel/dismiss edildiğinde) form gönderilir
                if (result.dismiss === Swal.DismissReason.cancel) {
                    const formId = (isApprove ? 'approve-form-' : 'reject-form-') + id;
        const form = document.getElementById(formId);
        if (form) {
            form.submit();
                    }
                }
            });
        }

    // Silme İşlemi İçin SweetAlert
    function confirmDelete(id) {
        Swal.fire({
            title: 'Kayıt Silinecek',
            text: "Bu işlem geri alınamaz!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Evet, Sil',
            cancelButtonText: 'İptal'
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('deleteForm_' + id).submit();
            }
        })
    }

    // Arama Tablosu Fonksiyonu
    function searchTable() {
        var input, filter, table, tr, td, i, txtValue;
        input = document.getElementById("searchInput");
        filter = input.value.toUpperCase();
        table = document.getElementById("borrowTable");
        tr = table.getElementsByTagName("tr");
        for (i = 1; i < tr.length; i++) {
            tr[i].style.display = "none";
            td = tr[i].getElementsByTagName("td");
            for (var j = 0; j < td.length; j++) {
                if (td[j]) {
                    txtValue = td[j].textContent || td[j].innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                        break;
                    }
                }
            }
        }
    }
</script>
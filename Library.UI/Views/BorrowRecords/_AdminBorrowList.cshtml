@model IEnumerable<Library.UI.Models.BorrowRecordListViewModel>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="row mb-3">
    <div class="col-md-6">
        <div class="input-group">
            <span class="input-group-text bg-white"><i class="fa-solid fa-magnifying-glass"></i></span>
            <input type="text" id="searchInput" onkeyup="searchTable()" class="form-control" placeholder="🔍 Kitap veya kullanıcı ara...">
        </div>
    </div>

    <div class="col-md-6">
        <div class="input-group">
            <span class="input-group-text bg-light fw-bold">Sıralama:</span>
            <select id="sortSelect" class="form-select" onchange="applySort()">
                <option value="default" selected>İade Bekleyenler</option>
                <option value="borrow_desc">Yeniden Eskiye</option>
                <option value="borrow_asc">Eskiden Yeniye</option>
            </select>
        </div>
    </div>
</div>

@if (!Model.Any())
{
    <div class="alert alert-info mt-3">Sistemde ödünç kaydı bulunmamaktadır.</div>
}
else
{
    <table class="table table-striped table-hover mt-3" id="borrowTable">
        <thead class="table-dark">
            <tr>
                <th>Kitap Adı</th>
                <th>Ödünç Alan</th>
                <th>Ödünç Tarihi</th>
                <th>İade Tarihi</th>
                <th>Durum</th>
                <th>İşlemler</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model
                    .OrderBy(x => x.IsReturned)
                    .ThenByDescending(x => x.BorrowDate))
            {
                <tr>
                    <td class="fw-bold">@item.BookTitle</td>
                    <td>@item.UserName</td>

                    <td data-date="@item.BorrowDate.ToString("yyyy-MM-dd")">
                        @item.BorrowDate.ToShortDateString()
                    </td>

                    <td data-date="@(item.ReturnDate.HasValue ? item.ReturnDate.Value.ToString("yyyy-MM-dd") : "9999-12-31")">
                        @if (item.ReturnDate.HasValue)
                        {
                            @item.ReturnDate.Value.ToShortDateString()
                        }
                        else
                        {
                            <span class="text-muted">-</span>
                        }
                    </td>

                    <td>
                        @if (item.IsReturned == true)
                        {
                            <span class="badge bg-success">İade Edildi</span>
                        }
                        else
                        {
                            <span class="badge bg-danger">Ödünç Alındı</span>
                        }
                    </td>

                    <td>
                        <form id="deleteForm_@item.Id" asp-controller="BorrowRecords" asp-action="Delete" asp-route-id="@item.Id" method="post" style="display:inline;">
                            <button type="button" class="btn btn-sm btn-danger" onclick="confirmDelete('@item.Id')">
                                <i class="fa-solid fa-trash"></i> Sil
                            </button>
                        </form>

                        @if (item.IsReturned != true)
                        {
                            <a asp-controller="BorrowRecords" asp-action="ReturnBook" asp-route-id="@item.Id" class="btn btn-sm btn-warning text-dark">
                                <i class="fa-solid fa-rotate-left"></i> İade Et
                            </a>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

<script>
    // --- MERKEZİ SIRALAMA FONKSİYONU ---
    function applySort() {
        var selectBox = document.getElementById("sortSelect");
        var selectedValue = selectBox.value; // Seçilen değer (örn: borrow_desc)

        var table = document.getElementById("borrowTable");
        var tbody = table.querySelector("tbody");
        var rows = Array.from(tbody.querySelectorAll("tr"));

        rows.sort(function (rowA, rowB) {
            // İADE DURUMUNU KONTROL ET (Index 4: Durum Sütunu)
            // Rozet metnini alıyoruz: "İade Edildi" veya "Ödünç Alındı"
            var statusA = rowA.cells[4].innerText.trim();
            var statusB = rowB.cells[4].innerText.trim();

            // "Ödünç Alındı" olanlar (İade Bekleyenler) önceliklidir (False)
            // "İade Edildi" olanlar sonradır (True)
            var isReturnedA = statusA.includes("İade Edildi");
            var isReturnedB = statusB.includes("İade Edildi");

            // --- 1. SENARYO: VARSAYILAN SIRALAMA (İki Aşamalı) ---
            if (selectedValue === "default") {
                // Önce iade durumuna bak (False önce gelir)
                if (isReturnedA !== isReturnedB) {
                    return isReturnedA - isReturnedB;
                }
                // Durumları aynıysa tarihe bak (En yeni tarih üstte)
                var dateA = new Date(rowA.cells[2].getAttribute("data-date"));
                var dateB = new Date(rowB.cells[2].getAttribute("data-date"));
                return dateB - dateA;
            }

            // --- 2. SENARYO: DİĞER TARİH SIRALAMALARI ---
            var dateA, dateB;

            // Ödünç Tarihi (Index 2)
            if (selectedValue.includes("borrow")) {
                dateA = new Date(rowA.cells[2].getAttribute("data-date"));
                dateB = new Date(rowB.cells[2].getAttribute("data-date"));
            }
            // İade Tarihi (Index 3)
            else if (selectedValue.includes("return")) {
                // İade tarihi yoksa (9999) en sona veya başa atma mantığı
                dateA = new Date(rowA.cells[3].getAttribute("data-date"));
                dateB = new Date(rowB.cells[3].getAttribute("data-date"));
            }

            if (selectedValue.includes("desc")) {
                return dateB - dateA;
            } else {
                return dateA - dateB;
            }
        });

        tbody.innerHTML = "";
        rows.forEach(function (row) {
            tbody.appendChild(row);
        });
    }

    // --- SİLME ONAY ---
    function confirmDelete(id) {
        Swal.fire({
            title: 'Emin misiniz?',
            text: "Bu kayıt kalıcı olarak silinecek!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Evet, Sil',
            cancelButtonText: 'İptal'
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('deleteForm_' + id).submit();
            }
        })
    }

    // --- ARAMA ---
    function searchTable() {
        var input = document.getElementById("searchInput");
        var filter = input.value.toUpperCase();
        var table = document.getElementById("borrowTable");
        var tbody = table.querySelector("tbody");
        var rows = tbody.getElementsByTagName("tr");

        for (var i = 0; i < rows.length; i++) {
            var tdBook = rows[i].getElementsByTagName("td")[0];
            var tdUser = rows[i].getElementsByTagName("td")[1];

            if (tdBook || tdUser) {
                var txtBook = tdBook.textContent || tdBook.innerText;
                var txtUser = tdUser.textContent || tdUser.innerText;
                if (txtBook.toUpperCase().indexOf(filter) > -1 || txtUser.toUpperCase().indexOf(filter) > -1) {
                    rows[i].style.display = "";
                } else {
                    rows[i].style.display = "none";
                }
            }
        }
    }
</script>
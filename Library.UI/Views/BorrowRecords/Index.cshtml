@model IEnumerable<Library.UI.Models.BorrowRecordListViewModel>
@inject IHttpContextAccessor HttpContextAccessor

@{
    ViewData["Title"] = "Ödünç İşlemleri";
    var userRole = HttpContextAccessor.HttpContext?.Session?.GetString("role");
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="container mt-4">

    <div class="d-flex align-items-center justify-content-between mb-3">
        @if (userRole == "admin")
        {
            <h2 class="text-dark fw-bold">
                <i class="fa-solid fa-user-gear text-primary me-2"></i>Ödünç İşlemleri Paneli
            </h2>
        }
        else
        {
            <h2 class="text-dark fw-bold">
                <i class="fa-solid fa-book-reader text-success me-2"></i>Ödünç Aldığım Kitaplar
            </h2>
        }
    </div>

    <hr class="mb-4" />

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
            <i class="fa-solid fa-circle-check me-2"></i> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert">
            <i class="fa-solid fa-circle-exclamation me-2"></i> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (userRole == "admin")
    {
        <partial name="_AdminBorrowList" model="Model" />
    }
    else if (userRole == "user")
    {
        <partial name="_UserBorrowList" model="Model" />
    }
    else
    {
        <div class="alert alert-warning text-center p-5 shadow-sm rounded">
            <i class="fa-solid fa-lock fa-3x mb-3 text-warning"></i>
            <h4>Erişim Engellendi</h4>
            <p class="text-muted">Bu sayfayı görüntülemek için lütfen giriş yapınız.</p>
            <a asp-controller="Login" asp-action="Index" class="btn btn-primary mt-2">Giriş Yap</a>
        </div>
    }

</div>

@section Scripts {
    <script>
        // --- 1. ADMİN İÇİN: ONAY VE RED ONAYI (TERS MANTIK) ---
        function confirmBorrowAction(id, type) {
            const isApprove = type === 'approve';

            Swal.fire({
                title: isApprove ? 'Onaylıyor musunuz?' : 'Reddediyor musunuz?',
                text: isApprove ? "İade işlemini onaylamak üzeresiniz." : "Bu iade talebi reddedilecektir.",
                icon: isApprove ? 'success' : 'warning',
                showCancelButton: true,
                confirmButtonColor: '#6c757d', // Vazgeç (Gri)
                cancelButtonColor: isApprove ? '#198754' : '#dc3545', // Evet (Yeşil/Kırmızı)
                confirmButtonText: 'Hayır',
                cancelButtonText: 'Evet',
                reverseButtons: true
            }).then((result) => {
                if (result.dismiss === Swal.DismissReason.cancel) {
                    const formId = isApprove ? 'approve-form-' + id : 'reject-form-' + id;
                    const form = document.getElementById(formId);
                    if (form) form.submit();
                }
            });
        }

        // --- 2. USER İÇİN: İADE TALEBİ ONAYI (TERS MANTIK GÜNCELLEMESİ) ---
        function confirmUserReturn(id) {
            Swal.fire({
                title: 'İade edilsin mi?',
                text: "Kitabı iade etmek istediğinizi onaylıyor musunuz?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#6c757d', // Vazgeç (Gri)
                cancelButtonColor: '#ffc107',  // Evet (Sarı)
                confirmButtonText: 'Vazgeç',
                cancelButtonText: 'Evet, İade Et',
                reverseButtons: true
            }).then((result) => {
                // "Evet, İade Et" butonuna basıldığında (teknik olarak iptal/cancel konumu) form gönderilir
                if (result.dismiss === Swal.DismissReason.cancel) {
                    const form = document.getElementById('return-form-' + id);
                    if (form) form.submit();
                }
            });
        }

        // --- MEVCUT MESAJ SCRIPTLERİ ---
        var lateAlert = '@Html.Raw(TempData["LateReturnAlert"])';
        if (lateAlert && lateAlert.length > 0) {
            Swal.fire({
                title: '⚠️ GEÇ İADE TESPİT EDİLDİ',
                html: lateAlert,
                icon: 'warning',
                iconColor: '#d33',
                confirmButtonColor: '#d33',
                confirmButtonText: 'Anladım, Dikkat Edeceğim'
            });
        }

        var successMsg = '@Html.Raw(TempData["SuccessMessage"])';
        if (successMsg && successMsg.length > 0) {
            Swal.fire({
                icon: 'success',
                title: 'İşlem Başarılı',
                text: successMsg,
                timer: 3000,
                showConfirmButton: false
            });
        }

        var errorMsg = '@Html.Raw(TempData["ErrorMessage"])';
        if (errorMsg && errorMsg.length > 0) {
            Swal.fire({
                icon: 'error',
                title: 'Hata Oluştu',
                text: errorMsg,
                confirmButtonColor: '#dc3545'
            });
        }
    </script>
}